From e7202e482cd40b299a61d8b28c295e7ffbe984f7 Mon Sep 17 00:00:00 2001
From: Yukihiro "Matz" Matsumoto <matz@ruby.or.jp>
Date: Sat, 7 May 2022 17:04:07 +0900
Subject: [PATCH] vm.c: create break object before clearing GC arena.

Otherwise it possibly cause use-after-free.

[iwamatsu]
  Backport to 3.0.0, and add reference tag.
Reference: CVE-2022-1212
Reference: https://huntr.dev/bounties/9fcc06d0-08e4-49c8-afda-2cae40946abe/
Reference: https://github.com/mruby/mruby/commit/3cf291f72224715942beaf8553e42ba8891ab3c6
Signed-off-by: Nobuhiro Iwamatsu <iwamatsu@debian.org>
---
 src/vm.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/vm.c b/src/vm.c
index f8b74034e..c5534d8a7 100644
--- a/src/vm.c
+++ b/src/vm.c
@@ -2109,9 +2109,9 @@ RETRY_TRY_BLOCK:
           }
           if (ci->acc < 0) {
             ci = cipop(mrb);
+            mrb->exc = (struct RObject*)break_new(mrb, RBREAK_TAG_BREAK, proc, v);
             mrb_gc_arena_restore(mrb, ai);
             mrb->c->vmexec = FALSE;
-            mrb->exc = (struct RObject*)break_new(mrb, RBREAK_TAG_BREAK, proc, v);
             mrb->jmp = prev_jmp;
             MRB_THROW(prev_jmp);
           }
-- 
2.36.0

