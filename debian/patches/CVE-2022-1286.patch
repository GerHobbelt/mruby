From e53c8383107a80490fe35046bd42286d8b09efaf Mon Sep 17 00:00:00 2001
From: Nobuhiro Iwamatsu <iwamatsu@debian.org>
Date: Sat, 7 May 2022 17:15:30 +0900
Subject: [PATCH] class.c: clear method cache after remove_method.

[iwmaatsu]
  backport to 3.0.0.
Reference: CVE-2022-1286
Reference: https://github.com/mruby/mruby/commit/b1d0296a937fe278239bdfac840a3fd0e93b3ee9
Reference: https://huntr.dev/bounties/f918376e-b488-4113-963d-ffe8716e4189/
Signed-off-by: Nobuhiro Iwamatsu <iwamatsu@debian.org>
---
 src/class.c | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/src/class.c b/src/class.c
index 09e52d24a..ca0cc55f9 100644
--- a/src/class.c
+++ b/src/class.c
@@ -2318,7 +2318,10 @@ mrb_remove_method(mrb_state *mrb, struct RClass *c, mrb_sym mid)
   MRB_CLASS_ORIGIN(c);
   h = c->mt;
 
-  if (h && mt_del(mrb, h, mid)) return;
+  if (h && mt_del(mrb, h, mid)) {
+    mrb_mc_clear_by_class(mrb, c);
+    return;
+  }
   mrb_name_error(mrb, mid, "method '%n' not defined in %C", mid, c);
 }
 
-- 
2.36.0

